⎕IO←0
c←⊃¨p←⊃⎕NGET'p17.txt'1
p←⍎¨¨'\d+'⎕S'&'¨p
a b←(⌊/,⌈/)∊1↓¨p/⍨c='x'
g←(1+b)1000⍴''
to←{⍺+⍳⍵-⍺}
{g[⍵[1] to 1+⍵[2];⍵[0]]←'#'}¨p/⍨c='x'
{g[⍵[0];⍵[1] to 1+⍵[2]]←'#'}¨p/⍨c='y'
d←{x y←⍵ ⋄ t←y↓g[;x] ⋄ n←1⍳⍨t∊'#~' ⋄ g[y+⍳n;x]←'|' ⋄ _←f⍣(n<t⍳'|')⊢x(y+n-1)}
e←{x y←⍵ ⋄ t←⍺∊⍨x⌽y⌷g ⋄ x+(-1⍳⍨⌽t)(t⍳1)}
f←{x y←⍵ ⋄ i j←'| 'e ⍵+0 1 ⋄ k l←'#'e ⍵ ⋄ g[y;(i⌈k)to j⌊l]←'|~'⊃⍨⍱/t←i l>k j ⋄ ⍱/t:∇⍵-0 1 ⋄ d¨y,⍨¨t/(i-1)j}
d 500 0
+/,'|~'∊⍨a↓g ⍝ part 1
+/,'~'=a↓g ⍝ part 2
